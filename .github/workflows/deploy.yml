name: Deploy to EC2

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-west-2
  ECR_REPOSITORY: wanly-gpu-registry
  CONTAINER_NAME: wanly-gpu-registry

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: Deploy to EC2 via SSM
        id: ssm-deploy
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          ENV_FILE="/opt/wanly-gpu-registry/.env"

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --timeout-seconds 300 \
            --parameters commands='[
              "set -e",
              "aws ecr get-login-password --region '"$AWS_REGION"' | docker login --username AWS --password-stdin '"$ECR_REGISTRY"'",
              "docker pull '"$IMAGE"'",
              "docker run --rm --network host --env-file '"$ENV_FILE"' '"$IMAGE"' alembic upgrade head",
              "docker stop '"$CONTAINER_NAME"' || true && docker rm '"$CONTAINER_NAME"' || true",
              "docker run -d --name '"$CONTAINER_NAME"' --restart unless-stopped --network host --env-file '"$ENV_FILE"' '"$IMAGE"'",
              "for i in 1 2 3 4 5 6; do curl -sf http://localhost:8000/docs && echo \"Health check passed\" && exit 0; echo \"Attempt $i failed, waiting 5s...\"; sleep 5; done; echo \"Health check failed\"; exit 1",
              "docker image prune -af --filter until=48h"
            ]' \
            --query 'Command.CommandId' \
            --output text)

          echo "command_id=$COMMAND_ID" >> "$GITHUB_OUTPUT"

      - name: Wait for deployment to complete
        env:
          COMMAND_ID: ${{ steps.ssm-deploy.outputs.command_id }}
        run: |
          echo "Waiting for SSM command $COMMAND_ID..."

          for i in $(seq 1 60); do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")

            case "$STATUS" in
              Success)
                echo "Deployment succeeded"
                aws ssm get-command-invocation \
                  --command-id "$COMMAND_ID" \
                  --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
                  --query 'StandardOutputContent' \
                  --output text
                exit 0
                ;;
              Failed|TimedOut|Cancelled)
                echo "Deployment failed with status: $STATUS"
                echo "--- STDOUT ---"
                aws ssm get-command-invocation \
                  --command-id "$COMMAND_ID" \
                  --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
                  --query 'StandardOutputContent' \
                  --output text
                echo "--- STDERR ---"
                aws ssm get-command-invocation \
                  --command-id "$COMMAND_ID" \
                  --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
                  --query 'StandardErrorContent' \
                  --output text
                exit 1
                ;;
              *)
                sleep 5
                ;;
            esac
          done

          echo "Timed out waiting for SSM command"
          exit 1
